# データ初期化計画（実装前）

## 1. 目的

- 初回起動時に、空DBでもタスク追加画面まで詰まらず到達できる初期状態を保証する。
- 初期化完了時点で、`Account`・`User`・`Project` が各1件以上存在し、即タスク追加できる状態にする。

## 2. 要件

- データ初期化時に `Account` を1件以上用意する。
- データ初期化時に `User` を1件以上用意する。
- データ初期化時に **`Project` を1件以上** 用意する。
- 初期プロジェクト名のデフォルトは **`My Tasks`** とする。
- 初期ローカルユーザー名のデフォルトは **`Local user`** とする。
- 初期化処理は冪等にし、既存データがある場合に重複作成しない。
- 既存ユーザーデータを破壊・上書きしない。

## 3. 初期データ仕様

### 3.1 作成対象

- Account（ローカル利用用のデフォルトアカウント）
- User（デフォルトローカルユーザー）
- Project（デフォルトプロジェクト）

### 3.2 初期レコード案

- Account
- `name`: `Local Account`（仮。命名は実装時に最終確定）
- `kind/type`: local を示す既定値
- その他必須カラム: DB制約に従う

- User
- `name`: `Local user`
- `account_id`: 初期Accountを参照
- その他必須カラム: DB制約に従う

- Project
- `name`: `My Tasks`
- `description`: 空（または `NULL`）
- `is_archived`: `false`
- `owner_user_id` または関連中間テーブル: 初期Userを参照
- その他必須カラム: DB制約に従う

### 3.3 関連付け要件

- 初期Userは初期Accountに紐づく。
- 初期Projectは初期Userからアクセス可能な状態にする。
- 初期化後、UIが「タスク追加先プロジェクト未選択」で止まらないよう、`My Tasks` を既定選択にできる状態を保証する。

### 3.4 作成条件（冪等）

- 各エンティティは「存在確認 -> 不足分のみ作成」で処理する。
- 推奨順序は `Account -> User -> Project`。
- 途中失敗時の不整合を避けるため、可能な範囲で同一トランザクション内で処理する。

## 4. 実装方針（次フェーズ）

1. アプリ起動時の初期化フローで、DB接続確立後に初期データチェックを実行する。
2. Repository層に `Account`・`User`・`Project` の存在確認APIを追加する。
3. 不足がある場合のみ、依存順で初期レコードを挿入する。
4. 初期Projectを起動直後の既定選択候補として扱えるよう、UI初期状態の読み取りロジックを確認する。
5. 初期化結果（作成/スキップ）をログに記録する。

## 5. テスト計画

### 5.1 正常系

- 空DB起動時: `Account`・`User`・`Project` が各1件作成される。
- 初期Project名が `My Tasks`、初期User名が `Local user` である。
- 初期化後にタスク追加処理が実行可能（追加先プロジェクト解決エラーが発生しない）。

### 5.2 冪等性

- 同一環境で初期化処理を複数回呼んでも、各初期レコードが重複しない。
- 既存データがある場合は不足分のみ補完される。

### 5.3 回帰観点

- 既存の `Account`・`User`・`Project` は名称や属性を勝手に変更しない。
- アーカイブ済みや削除フラグ付きデータに副作用がない。

## 6. 未確定事項

- `Local Account` の最終表示名（固定英語名かローカライズ名か）。
- 「既定選択プロジェクト」を永続化設定で持つか、起動時に先頭/唯一プロジェクトを自動選択するか。
- 既存データが部分的に欠けるケース（例: Accountのみ存在）での補完ポリシー詳細。

## 7. 完了条件（実装フェーズの Definition of Done）

- 初回起動時に `Account`・`User`・`Project` が各1件以上存在することを自動テストで保証。
- `My Tasks` と `Local user` の初期作成が確認できること。
- 初期化処理の冪等性テストが通過すること。
- 初期化直後にタスク追加が可能であることを結合テストで確認できること。
