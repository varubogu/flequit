# アーキテクチャ設計書

## 1. システム概要

### 1.1 アプリケーション構成

- デスクトップアプリケーション版
  - フロントエンド: SvelteKit (SSG+CSR)
  - バックエンド: Tauri
  - データベース: SQLite
- Webアプリケーション版
  - フロントエンド: SvelteKit (SSG+CSR)
  - バックエンド: Supabase
  - データベース: PostgreSQL

### 1.2 主要コンポーネント

- UIレイヤー
  - コンポーネント: Svelte + shadcn-svelte
  - 状態管理:
    - リアクティブストア（`src/lib/stores/…`）はビュー状態のキャッシュのみを担当（例: `ViewStore`, `TaskDetailViewStore`）
    - UIサービス（`src/lib/services/ui/…`）は副作用・ストア間の調停・バックエンド連携を担当
  - ルーティング: SvelteKit
- ビジネスロジックレイヤー
  - タスク管理
  - プロジェクト管理
  - 同期処理
- データアクセスレイヤー
  - AutoMergeをベースとしてデータ構造
  - ローカル（Tauriアプリ）ではSQLiteを追加し、データ検索はSQLiteのみ、データ更新はSQLite、Automergeの順で保存する
  - WebではPostgreSQLを追加し、データ検索はPostgreSQLのみ、データ更新はPostgreSQL、Automergeの順で保存する
  - クラウドストレージ（Automerge）の同期も対応
  - 将来的にはGitでも同期可能

## 2. アプリケーション版アーキテクチャ

### 2.1 SvelteKit+Tauriアーキテクチャ

- フロントエンド（SvelteKit）
  - SSG生成された静的ファイル
  - CSRによる動的更新
  - WebViewでの表示
- バックエンド（Tauri/Rust）- クレート分割アーキテクチャ
  - **flequit（メインクレート）**: Tauriコマンド、システムAPI連携、OS機能
  - **flequit-core（ビジネスロジック）**: サービス層、ファサード層
  - **flequit-storage（ストレージ層）**: Repository、データベース操作、ファイルI/O
  - 各クレートは独立してビルド・テスト可能

### 2.2 データフロー

- ローカルファーストアプローチ
  - ローカルデータの即時反映
  - バックグラウンド同期
  - オフライン対応
- SQLiteデータベース
  - WAL（Write-Ahead Logging）モード
  - インメモリキャッシュ
  - トランザクション最適化

## 3. Webアプリケーション版アーキテクチャ

### 3.1 SvelteKit+Supabaseアーキテクチャ

- フロントエンド（SvelteKit）
  - 静的サイト生成
  - クライアントサイドレンダリング
  - Cloudflare Pages hosting
- バックエンド（Supabase）
  - PostgreSQLデータベース
  - リアルタイム更新
  - Row Level Security

### 3.2 データフロー

- リアルタイムデータ同期
  - WebSocketsによる双方向通信
  - 差分更新
  - コンフリクト解決
- キャッシュ戦略
  - ブラウザキャッシュ
  - CDNキャッシュ
  - アプリケーションキャッシュ

## 4. パフォーマンス最適化

### 4.1 フロントエンド最適化

- バンドルサイズの最小化
  - コード分割
  - 遅延ロード
  - アセット最適化
- レンダリング最適化
  - 仮想スクロール
  - メモ化
  - レンダリングスロットリング

### 4.2 バックエンド最適化

- データベースパフォーマンス
  - インデックス最適化
  - クエリ最適化
  - コネクションプール
- キャッシュ戦略
  - メモリキャッシュ
  - クエリキャッシュ
  - 結果キャッシュ

## 5. スケーラビリティ設計

### 5.1 アプリケーション版

- 効率的なリソース使用
  - メモリ使用量の最適化
  - CPU負荷の分散
  - ディスクI/O最適化
- データ同期の効率化
  - バッチ処理
  - 差分同期
  - 優先度制御

### 5.2 Webアプリケーション版

- 水平スケーリング
  - ステートレス設計
  - 負荷分散
  - シャーディング
- 垂直スケーリング
  - リソース最適化
  - パフォーマンスチューニング
  - ボトルネック解消

## 6. セキュリティアーキテクチャ

### 6.1 アプリケーション版

- Tauriセキュリティ機能
  - CSP（Content Security Policy）
  - サンドボックス化
  - 暗号化ストレージ
- データ保護
  - ファイル暗号化
  - 安全な通信
  - アクセス制御

### 6.2 Webアプリケーション版

- Supabaseセキュリティ機能
  - RLS（Row Level Security）
  - JWT認証
  - SSL/TLS暗号化
- アプリケーションセキュリティ
  - XSS対策
  - CSRF対策
  - 入力検証

## 7. 監視と運用

### 7.1 モニタリング

- パフォーマンス監視
  - レスポンスタイム
  - リソース使用率
  - エラー率
- ユーザー体験監視
  - Core Web Vitals
  - クラッシュレポート
  - 使用統計

### 7.2 運用管理

- ログ管理
  - エラーログ
  - アクセスログ
  - 監査ログ
- バックアップ
  - データバックアップ
  - 設定バックアップ
  - リストア手順
