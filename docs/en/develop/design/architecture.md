# Architecture Design Document

## 1. System Overview

### 1.1 Application Configuration

- Desktop Application Version
  - Frontend: SvelteKit (SSG+CSR)
  - Backend: Tauri
  - Database: SQLite
- Web Application Version
  - Frontend: SvelteKit (SSG+CSR)
  - Backend: Supabase
  - Database: PostgreSQL

### 1.2 Main Components

- UI Layer
  - Components: Svelte + shadcn-svelte
  - State Management:
    - Reactive stores (`src/lib/stores/…`) cache view state only (e.g., `ViewStore`, `TaskDetailViewStore`)
    - UI services (`src/lib/services/ui/…`) encapsulate side effects, orchestration, and cross-store coordination
  - Routing: SvelteKit
- Business Logic Layer
  - Task management
  - Project management
  - Synchronization processing
- Data Access Layer
  - Data structure based on AutoMerge
  - Local (Tauri app): SQLite is added, data search uses SQLite only, data updates are saved in order of SQLite, Automerge
  - Web: PostgreSQL is added, data search uses PostgreSQL only, data updates are saved in order of PostgreSQL, Automerge
  - Cloud storage (Automerge) synchronization support
  - Future support for Git synchronization

## 2. Desktop Application Architecture

### 2.1 SvelteKit+Tauri Architecture

- Frontend (SvelteKit)
  - Static files generated by SSG
  - Dynamic updates via CSR
  - Display in WebView
- Backend (Tauri/Rust) - Crate separation architecture
  - **flequit (main crate)**: Tauri commands, system API integration, OS features
  - **flequit-core (business logic)**: Service layer, facade layer
  - **flequit-storage (storage layer)**: Repository, database operations, file I/O
  - Each crate can be built and tested independently

### 2.2 Data Flow

- Local-first approach
  - Immediate reflection of local data
  - Background synchronization
  - Offline support
- SQLite database
  - WAL (Write-Ahead Logging) mode
  - In-memory cache
  - Transaction optimization

## 3. Web Application Architecture

### 3.1 SvelteKit+Supabase Architecture

- Frontend (SvelteKit)
  - Static site generation
  - Client-side rendering
  - Cloudflare Pages hosting
- Backend (Supabase)
  - PostgreSQL database
  - Real-time updates
  - Row Level Security

### 3.2 Data Flow

- Real-time data synchronization
  - Bidirectional communication via WebSockets
  - Differential updates
  - Conflict resolution
- Caching strategy
  - Browser cache
  - CDN cache
  - Application cache

## 4. Performance Optimization

### 4.1 Frontend Optimization

- Bundle size minimization
  - Code splitting
  - Lazy loading
  - Asset optimization
- Rendering optimization
  - Virtual scrolling
  - Memoization
  - Rendering throttling

### 4.2 Backend Optimization

- Database performance
  - Index optimization
  - Query optimization
  - Connection pooling
- Caching strategy
  - Memory cache
  - Query cache
  - Result cache

## 5. Scalability Design

### 5.1 Desktop Application

- Efficient resource usage
  - Memory usage optimization
  - CPU load distribution
  - Disk I/O optimization
- Data synchronization efficiency
  - Batch processing
  - Differential synchronization
  - Priority control

### 5.2 Web Application

- Horizontal scaling
  - Stateless design
  - Load balancing
  - Sharding
- Vertical scaling
  - Resource optimization
  - Performance tuning
  - Bottleneck elimination

## 6. Security Architecture

### 6.1 Desktop Application

- Tauri security features
  - CSP (Content Security Policy)
  - Sandboxing
  - Encrypted storage
- Data protection
  - File encryption
  - Secure communication
  - Access control

### 6.2 Web Application

- Supabase security features
  - RLS (Row Level Security)
  - JWT authentication
  - SSL/TLS encryption
- Application security
  - XSS countermeasures
  - CSRF countermeasures
  - Input validation

## 7. Monitoring and Operations

### 7.1 Monitoring

- Performance monitoring
  - Response time
  - Resource usage rate
  - Error rate
- User experience monitoring
  - Core Web Vitals
  - Crash reports
  - Usage statistics

### 7.2 Operations Management

- Log management
  - Error logs
  - Access logs
  - Audit logs
- Backup
  - Data backup
  - Configuration backup
  - Restore procedures
