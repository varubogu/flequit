
# 日時フォーマットに関する仕様

## データ構造

下記ファイルを参照すること
- プロジェクトルートの `docs/develop/design/database/schema_users/tables/datetime_formats.md` を参照

## フォーマット適用先

- 日時入力コンポーネント全般
- 日時表示コンポーネント全般

## group(enum)について

groupは大まかに4種類のグループに分類される

1. デフォルト（空文字）※常に１つ、アプリ上で定義され変更不可
2. プリセット（アプリで定義されたもの）※アプリ上で定義され変更不可
3. カスタム（ユーザーが自由にテキスト入力）※常に１つ、ユーザー入力済みで
4. カスタムフォーマット（ユーザーが定義したフォーマット）

## ID体系について

- **アプリ固定データ（デフォルト・プリセット）**: 負の整数を使用（例：-1, -2など）
- **ユーザーカスタムデータ（カスタムフォーマット）**: UUIDを使用
- アプリ固定データはデータベースに保存せず、プログラム内で定義

## アプリで用意するデータ
- デフォルトに該当するデータ（id:-1, name:言語設定に応じて「デフォルト」の意味の文字, format:空文字,group:デフォルト,order:0
- プリセットに該当するデータ、国ごとの標準設定が定義される ※TypeScriptファイル内でオブジェクトとして管理する
  - 例:
    - id:jp-0, name:日本（西暦、24時間表記）, format:yyyy年MM月dd日 HH:mm:ss, group:プリセット, order:0
    - id:jp-1, name:日本（和暦、12時間表記）, format:yyyy年MM月dd日 hh:mm:ss, group:プリセット, order:0
    - id:en-1, name:America, format:MM/dd/yyyy HH:mm:ss, group:プリセット, order:1
- 「カスタム」に該当するデータ（id:-2, name:言語設定に応じて「カスタム」の意味の文字, format:空文字,group:カスタム,order:0

# コンポーネント一覧

## テスト日時入力（日付、時刻入力）※新規作成するコンポーネント

- 日時フォーマットやテストフォーマットのプレビューで使う。
- ダイアログ初期表示時に現在日時を反映、以後はユーザーが自由に入力できる

## 日時フォーマット（テキストボックス）

- アプリ上で扱うフォーマット
- 設定値ストアと常に同期（呼び出し元にも反映されるように）

## 日時フォーマットプレビュー

- テスト日時入力と日時フォーマットの内容で日時を表示する

## 「↓」ボタン

- 日時フォーマットをテストフォーマットに反映する

## 「↑」ボタン

- テストフォーマットを日時フォーマットに反映する


## テストフォーマット（テキストボックス）

- ユーザーが日時フォーマット変更前に試すためのテキストボックス

## テストフォーマットプレビュー

- テスト日時入力とテストフォーマットの内容で日時を表示する

## テストフォーマット選択（コンボボックス）

- テストフォーマットと紐づいている。
- 選択変更時にテストフォーマットへ反映する

## フォーマット名変更前ラベル

- フォーマット選択で「カスタムフォーマット」が選択されている場合のみ表示する
- 「変更前ラベル」→「フォーマット名テキストボックス」という見栄えになるようにする

## フォーマット名テキストボックス

- フォーマット選択で「カスタム」「カスタムフォーマット」が選択されている場合のみ表示する
- カスタムフォーマットに名前をつける、あるいは変更するための項目

## 「フォーマット追加」ボタン

- フォーマット選択で「カスタム」「カスタムフォーマット」が選択されている場合のみ表示する
- カスタムフォーマットを追加するためのボタン

## 「フォーマット上書き」ボタン

- フォーマット選択で「カスタムフォーマット」が選択されている場合のみ表示する
- カスタムフォーマットを保存するためのボタン

## 「フォーマット削除」ボタン

- フォーマット選択で「カスタムフォーマット」が選択されている場合のみ表示する
- カスタムフォーマットを削除するためのボタン
- 確認ダイアログを表示してから削除する

## イベントごとの処理内容

### 初期表示時
日時フォーマットの内容をテストフォーマットにコピーする（同期はしない）
それに伴い「テストフォーマット選択」の選択状態が変化し、その後「フォーマット名」「フォーマットを保存」の表示状態が変化

### 日時フォーマット入力変更時
紐づくストアを更新する

### ↓ボタン押下時、
日時フォーマットをテストフォーマットに反映
それに伴い「テストフォーマット選択」、「フォーマット名」「フォーマットを保存」の状態が変化

### ↑ボタン押下時
テストフォーマットを日時フォーマットに反映

### テストフォーマット入力変更時
- formatが一致するものがあればそれを「テストフォーマット選択」で自動選択する。その後「変更前フォーマット名」「フォーマット名」「フォーマット追加」「フォーマット上書き」の表示状態が変化

### テストフォーマット選択コンボボックス選択変更時
- 「カスタム」が選択されたら何もしない
- 「カスタム」以外の場合、入力内容に応じて「テストフォーマット選択」の選択状態が変化、それに伴い、「フォーマット名」「フォーマットを保存」の表示状態が変化

### フォーマット名テキストボックス変更時
特になし

### フォーマット追加押下時
フォーマットの新規追加を行う
idは新規にUUIDを割り振る。もし衝突したら成功するまで最大10回再割り当てをする。

### フォーマット上書き押下時
idが一致するフォーマットを直接書き換える

# UI状態管理設計

## 状態の所有者と責任

### ストア管理（即座反映）
- `currentFormat`: 現在の日時フォーマット（設定値）
- `customFormats`: ユーザー定義のカスタムフォーマット一覧
- `allFormats`: アプリ固定 + カスタムフォーマットの統合リスト（$derived）

### 親コンポーネント管理（ローカル状態）
- `testDateTime`: テスト用日時入力
- `testFormat`: テストフォーマット（試行用、ストアとは独立）
- `testFormatName`: フォーマット名入力
- `selectedPreset`: 選択中のプリセット（$derived で testFormat から自動算出）

## リアクティブ更新パターン

### 初期化時
```typescript
$effect(() => {
  testFormat = store.currentFormat; // ストアから初期値を取得
});
```

### 状態同期
- **日時フォーマット変更**: 即座にストア反映（電源断対策）
- **カスタムフォーマット操作**: 即座にストア反映
- **テストフォーマット変更**: selectedPreset が $derived で自動更新

# 注意点
- イベントごとの処理内容が破綻しないようにSvelte5のrunesなどを使って表現

## バリデーション方針
- 日時フォーマット文字列の妥当性チェックはユーザー責任とし、アプリ側では基本的にバリデーションを行わない
- 不正なフォーマットでもそのまま保存・表示し、実際の日時変換時にエラーが発生した場合は適切にハンドリングする

## 国際化対応方針
- プリセット名やUI表示の多言語対応は、Svelteストア内の言語設定をベースとする
- アプリ固定データ（デフォルト・プリセット）の表示名は、プログラム内で言語設定に応じて動的に生成する
